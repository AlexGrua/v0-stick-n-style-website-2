# Отчет о миграции SKU

## Проблема
SKU хранился в JSONB поле `specifications->>'sku'`, что вызывало:
- Ошибки `PGRST204: Could not find the 'sku' column of 'products' in the schema cache`
- Медленные запросы по JSONB
- Отсутствие уникальности на уровне БД
- Сложности с индексацией

## Решение
Выполнена безопасная миграция SKU из JSONB в отдельную колонку.

### Выполненные шаги:

1. **Создание SQL миграции** (`scripts/fix-sku-migration.sql`)
   - Добавление колонки `sku TEXT`
   - Перенос данных из `specifications->>'sku'` в колонку
   - Создание уникального индекса `products_sku_unique_notnull`
   - Обновление кеша PostgREST

2. **Обновление API endpoints**
   - `app/api/products/route.ts`: 
     - Поиск по `sku` вместо `specifications->>sku`
     - Чтение `sku` из колонки с fallback на JSONB
     - Запись `sku` в отдельную колонку при создании
   - `app/api/products/import/route.ts`:
     - Проверка существования по `sku` колонке
     - Запись `sku` в отдельную колонку при импорте

3. **Проверка результатов**
   - ✅ Колонка `sku` добавлена
   - ✅ Данные перенесены
   - ✅ Уникальный индекс создан
   - ✅ API работает корректно
   - ✅ Поиск по SKU работает

### Преимущества новой схемы:

1. **Производительность**
   - Быстрые запросы по обычному индексу
   - Простая фильтрация и сортировка
   - Эффективные JOIN'ы

2. **Целостность данных**
   - UNIQUE constraint на уровне БД
   - Гарантия уникальности SKU
   - Защита от дублирования

3. **Простота использования**
   - Прямые запросы к колонке
   - Читаемый SQL код
   - Стандартные операции

### Совместимость:
- Обратная совместимость сохранена (fallback на JSONB)
- Постепенный переход на новую схему
- Возможность удаления `sku` из JSONB в будущем

### Статус:
✅ **МИГРАЦИЯ ЗАВЕРШЕНА УСПЕШНО**

Все API endpoints обновлены и работают с новой схемой. SKU теперь хранится в отдельной колонке с уникальным индексом.
