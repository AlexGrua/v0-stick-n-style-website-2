# Инструкция по выполнению миграции в Supabase

## Проблема
Миграция SKU и создание таблицы subcategories не были применены в Supabase, поэтому:
- Колонка `sku` отсутствует в таблице `products`
- Таблица `subcategories` не создана
- API выдает ошибки `PGRST204`
- **НОВОЕ**: Обнаружены дубликаты SKU, которые блокируют создание уникального индекса

## Решение

### Шаг 1: Откройте Supabase Console
1. Перейдите в [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в **SQL Editor**

### Шаг 2: Выполните миграцию subcategories
1. Скопируйте содержимое файла `scripts/create-subcategories-table.sql`
2. Вставьте в SQL Editor
3. Нажмите **Run** (или Ctrl+Enter)
4. Дождитесь выполнения

### Шаг 3: Выполните миграцию SKU (если еще не выполнена)
1. Скопируйте содержимое файла `scripts/apply-sku-migration.sql`
2. Вставьте в SQL Editor
3. Нажмите **Run** (или Ctrl+Enter)
4. Дождитесь выполнения

### Шаг 4: Исправьте дубликаты SKU
**ВАЖНО**: Если получили ошибку "duplicate key", выполните один из вариантов:

#### Вариант A: Удаление дубликатов (оставляет только один продукт на SKU)
1. Скопируйте содержимое файла `scripts/fix-sku-duplicates.sql`
2. Вставьте в SQL Editor
3. Нажмите **Run**

#### Вариант B: Добавление суффиксов (сохраняет все продукты)
1. Скопируйте содержимое файла `scripts/fix-sku-duplicates-alternative.sql`
2. Вставьте в SQL Editor
3. Нажмите **Run**

### Шаг 5: Проверьте результат
1. Перейдите в **Table Editor**
2. Проверьте, что:
   - В таблице `products` появилась колонка `sku`
   - Создана таблица `subcategories`
   - В `subcategories` есть демо-данные
   - Нет дубликатов SKU

### Шаг 6: Перезапустите приложение
1. Остановите dev сервер (Ctrl+C)
2. Запустите заново: `npm run dev`

## Ожидаемый результат

После выполнения миграции:
- ✅ Колонка `sku` добавлена в `products`
- ✅ Таблица `subcategories` создана
- ✅ Уникальный индекс на `sku` создан
- ✅ Дубликаты SKU устранены
- ✅ Демо-данные добавлены
- ✅ RLS отключен для разработки
- ✅ Кеш PostgREST обновлен

## Проверка

После миграции проверьте:
1. Создание категории работает
2. Создание продукта работает
3. Импорт продуктов работает
4. Список продуктов отображается

## Если что-то пошло не так

1. **Ошибка "duplicate key"**: Выполните скрипт исправления дубликатов
2. **Ошибка "relation does not exist"**: Убедитесь, что таблица `categories` существует
3. **Ошибка "permission denied"**: Проверьте права доступа в Supabase

## Файлы миграции

- `scripts/create-subcategories-table.sql` - создание таблицы subcategories
- `scripts/apply-sku-migration.sql` - миграция SKU
- `scripts/fix-sku-duplicates.sql` - удаление дубликатов SKU
- `scripts/fix-sku-duplicates-alternative.sql` - добавление суффиксов к дубликатам
- `MIGRATION_INSTRUCTIONS.md` - эта инструкция

## Выбор стратегии для дубликатов

- **Вариант A (удаление)**: Если дубликаты - это ошибка данных, и нужно оставить только один продукт
- **Вариант B (суффиксы)**: Если дубликаты - это разные варианты одного продукта, и нужно сохранить все
